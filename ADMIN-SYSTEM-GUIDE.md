# מערכת ניהול משתמשים והתחזות

## סקירה
המערכת כוללת שתי רמות הרשאה:
- **משתמש (User)** - הרשאות רגילות, גישה לבוטים ותהליכים שלו בלבד
- **מנהל (Admin)** - גישה לפאנל ניהול, צפייה בכל המשתמשים, והתחזות למשתמשים

## יכולות מנהל

### פאנל ניהול
- צפייה ברשימת כל המשתמשים במערכת
- צפייה בפרטים מלאים של כל משתמש:
  - שם, אימייל, טלפון
  - תפקיד (מנהל/משתמש)
  - סוג חשבון וסטטוס
  - API Token
  - סטטיסטיקות (מספר בוטים ותהליכים)
  - תאריך יצירה

### התחזות למשתמש (Impersonation)
- לחיצה על "התחזות למשתמש" תעביר את המנהל לצפייה במערכת כמשתמש זה
- במצב התחזות:
  - רואים בדיוק מה שהמשתמש רואה
  - יש באנר כתום בראש העמוד המציין מצב התחזות
  - כפתור "חזור למצב מנהל" מאפשר חזרה למנהל
  - ההתחזות תוקפת ל-2 שעות

### ניהול תפקידים
- מנהל יכול להפוך משתמש רגיל למנהל
- מנהל יכול להוריד מנהל אחר למשתמש רגיל
- לא ניתן לשנות את התפקיד של עצמך

## Backend API

### Routes חדשים
```
GET    /api/admin/users              - קבלת רשימת כל המשתמשים (מנהל בלבד)
GET    /api/admin/users/:userId      - פרטי משתמש ספציפי (מנהל בלבד)
POST   /api/admin/impersonate/:userId - התחזות למשתמש (מנהל בלבד)
POST   /api/admin/stop-impersonation  - חזרה ממצב התחזות
PATCH  /api/admin/users/:userId/role  - עדכון תפקיד משתמש (מנהל בלבד)
```

### Middleware חדש
- `requireAdmin` - בודק שהמשתמש הוא מנהל, נדרש לכל endpoints של הניהול

### Controllers
- `adminController.js` - מכיל את כל הלוגיקה לניהול משתמשים והתחזות

## Frontend

### רכיבים חדשים
- `AdminPanel.tsx` - פאנל ניהול מלא עם רשימת משתמשים ויכולות התחזות

### שינויים ב-App.tsx
- הוספת `viewMode: 'admin-panel'`
- פונקציות `handleImpersonate` ו-`handleStopImpersonation`
- העברת props חדשים ל-Dashboard

### שינויים ב-Dashboard.tsx
- באנר כתום למצב התחזות (בראש העמוד)
- כפתור "פאנל ניהול" (רק למנהלים)
- כפתור "חזור למצב מנהל" (רק במצב התחזות)

## שימוש

### הפיכת משתמש למנהל
1. רשום את כל המשתמשים:
   ```bash
   cd backend
   node list-users.js
   ```

2. הפוך משתמש למנהל:
   ```bash
   node make-admin.js user@example.com
   ```

### כניסה למערכת כמנהל
1. התחבר עם משתמש שהוגדר כמנהל
2. בדשבורד, תראה כפתור "פאנל ניהול" ליד שם המשתמש
3. לחץ על הכפתור להיכנס לפאנל הניהול

### התחזות למשתמש
1. בפאנל הניהול, בחר משתמש מהרשימה
2. לחץ על "התחזות למשתמש"
3. תעבור אוטומטית לדשבורד של המשתמש
4. באנר כתום יופיע בראש העמוד המציין מצב התחזות
5. לחץ על "חזור למצב מנהל" בבאנר כדי לחזור

### ניהול תפקידים
1. בפאנל הניהול, בחר משתמש
2. לחץ על "הפוך למנהל" או "הורד מתפקיד מנהל"
3. התפקיד יתעדכן מיידית

## אבטחה

### Token Expiration
- טוקני התחזות תוקפים ל-2 שעות בלבד
- טוקני משתמש רגילים לא פג תוקפם

### הגבלות
- רק משתמשים עם `role: 'admin'` יכולים לגשת ל-endpoints של הניהול
- מנהל לא יכול לשנות את התפקיד של עצמו
- כל פעולות הניהול מוגבלות ב-middleware `requireAdmin`

### Tracking
- במצב התחזות, ה-JWT כולל:
  - `isImpersonating: true`
  - `impersonatedBy: <admin-user-id>`
- זה מאפשר מעקב אחר מי ביצע התחזות

## שינויים במודלים

### User Model
```javascript
{
  role: { type: String, default: 'user' }, // 'admin' or 'user'
  // שאר השדות...
}
```

### User Interface (Frontend)
```typescript
interface User {
  role?: 'admin' | 'user';
  isImpersonating?: boolean;
  impersonatedBy?: string;
  // שאר השדות...
}
```

## בדיקות

### בדיקת פונקציונליות
1. צור משתמש רגיל והתחבר
2. ודא שאין גישה לפאנל ניהול
3. הפוך את המשתמש למנהל דרך הסקריפט
4. התחבר מחדש
5. ודא שכפתור "פאנל ניהול" מופיע
6. נסה התחזות למשתמש אחר
7. ודא שהבאנר הכתום מופיע
8. ודא שרואים את הבוטים של המשתמש המותחז
9. חזור למצב מנהל
10. ודא שחזרת לחשבון המנהל

## תמיכה טכנית
במקרה של בעיות, בדוק:
- שהשרת רץ עם הקוד המעודכן
- שהמשתמש הוגדר כמנהל בדטהבייס
- שה-localStorage מכיל את ה-token המעודכן
- שאין שגיאות ב-console של הדפדפן
